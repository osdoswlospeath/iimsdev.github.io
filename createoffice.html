<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IIMS | สร้างรหัสสำนักงาน</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="header-wrap">
    <div class="header">
      <div class="brand">
        <div class="logo"><span style="font-weight:700;color:var(--purple);">LOGO</span></div>
        <div>
          <h1 class="title-th">ระบบสารสนเทศการบริหารข้อมูลการประกันภัย <span style="color:var(--gold); font-size: 16px;">(DEV MODE)</span> </h1>
          <div class="title-en">Insurance Information Management System : IIMS</div>
          <div class="subtitle">แผนกงานประกันภัย กองสนับสนุนงานองค์กร</div>
        </div>
      </div>
    </div>
  </div>

  <div class="nav">
    <div class="nav-inner">
      <a class="link" href="index.html">หน้าแรก</a>
      <span class="link active">สร้างรหัสสำนักงาน</span>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h2>สร้างรหัสสำนักงาน</h2>
      <p class="notice">ระบุชื่อและที่ตั้งสำนักงาน ระบบจะสร้างข้อมูล <code>area_code</code> ให้อัตโนมัติ</p>

      <div class="form-row">
        <label>ชื่อสำนักงาน</label>
        <input type="text" id="branName" placeholder="เช่น การไฟฟ้าส่วนภูมิภาค สาขาเมืองเชียงใหม่" oninput="updatePreview()" />
      </div>

      <div class="grid">
        <div class="form-row">
          <label> เลขที่ / อาคาร / หมู่ </label>
          <input type="text" id="addrHouse" placeholder="เช่น เลขที่ 123/4 หมู่ 5" oninput="updatePreview()" />
        </div>
        <div class="form-row">
          <label>ซอย / ถนน</label>
          <input type="text" id="addrRoad" placeholder="เช่น ถนนพหลโยธิน หรือ - " oninput="updatePreview()" />
        </div>
        <div class="form-row">
          <label>รหัสไปรษณีย์</label>
          <input type="text" id="zipCode" placeholder="เช่น 10110" maxlength="5" oninput="updatePreview()" />
        </div>
      </div>

      <div class="grid">
        <div class="form-row">
          <label>พื้นที่</label>
          <select id="area" onchange="filterDropdown('prov')"><option value="">— เลือกพื้นที่ —</option></select>
        </div>
        <div class="form-row">
          <label>จังหวัด</label>
          <select id="prov" disabled onchange="filterDropdown('dist')"><option value="">— เลือกจังหวัด —</option></select>
        </div>
        <div class="form-row">
          <label>อำเภอ/เขต</label>
          <select id="dist" disabled onchange="filterDropdown('subd')"><option value="">— เลือกอำเภอ —</option></select>
        </div>
        <div class="form-row">
          <label>ตำบล/แขวง</label>
          <select id="subd" disabled onchange="updatePreview()"><option value="">— เลือกตำบล —</option></select>
        </div>
      </div>

      <div class="preview" style="text-align: left; padding: 20px;">
        <div style="margin-bottom: 15px;">
          <strong style="color:var(--purple);">1. ชื่อสำนักงาน:</strong>
          <div id="viewName" style="font-size: 1.1rem; margin-top: 5px;">—</div>
        </div>
        <div style="margin-bottom: 15px;">
          <strong style="color:var(--purple);">2. รหัสสำนักงาน:</strong><br>
          <div id="previewCode" class="badge">—</div>
        </div>
        <div>
          <strong style="color:var(--purple);">3. ที่อยู่:</strong>
          <div id="viewAddress" style="font-size: 0.95rem; margin-top: 5px; line-height: 1.6;">—</div>
        </div>
      </div>

      <div class="actions" style="justify-content: center; margin-top: 24px;">
        <button onclick="location.reload()" class="btn">ล้างข้อมูล</button>
        <button id="saveBtn" class="btn primary" disabled>บันทึกข้อมูล</button>
      </div>

      <div class="footer">
      © <span id="year"></span> IIMS — แผนกงานประกันภัย กองสนับสนุนงานองค์กร
      </div>
    </div>
  </div>

  
  <script>

      // 1. ย้ายมาไว้บนสุด เพื่อให้รันก่อนเพื่อน
    window.onload = function() {
      try {
        // ใส่ปีปัจจุบัน (กันเหนียวถ้าหา id year ไม่เจอ จะได้ไม่พังทั้งระบบ)
        const yearEl = document.getElementById('year');
        if (yearEl) yearEl.textContent = new Date().getFullYear();
        
        // เรียกโหลดข้อมูล
        loadData();
      } catch (e) {
        console.error("Error in onload:", e);
      }
    };
  
    document.getElementById('year').textContent = new Date().getFullYear();
    
  // URL เดิมของคุณ
    const API_URL = "https://script.google.com/macros/s/AKfycbz8zohztNMZnGpYzQ-vSL6Uj6AZKP9npCsOUC3zSAYJnzkB3yy1OKar2yasMxGmVv_G/exec";
  
    let rawData = [];
  
    async function loadData() {
    console.log("Starting to load data..."); // เช็คใน Console ว่าฟังก์ชันทำงานไหม
    try {
      // เรียก API แบบเรียบง่ายที่สุด (Default คือ GET)
      const response = await fetch(API_URL); 
      
      if (!response.ok) throw new Error('Network response was not ok');
      
      rawData = await response.json();
      console.log("Data received:", rawData); // ดูว่าข้อมูลมาเป็น Array หรือไม่

      if (rawData.length > 0) {
        populateArea();
      } else {
        console.warn("No data found in sheet 'area_code'");
      }
    } catch (err) {
      console.error("Error loading data:", err);
    }
  }
  
    // ฟังก์ชันบันทึกข้อมูล
    async function saveData() {
      const btn = document.getElementById('saveBtn');
      btn.disabled = true;
      btn.innerText = "กำลังบันทึก...";
  
      const payload = {
        action: 'saveOffice',
        data: {
          bran_thai: document.getElementById('branName').value,
          address_full: document.getElementById('viewAddress').innerText,
          bran_iden: document.getElementById('previewCode').innerText,
          area: document.getElementById('area').value,
          prov: document.getElementById('prov').value,
          dist: document.getElementById('dist').value,
          subd: document.getElementById('subd').value
        }
      };
  
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors', // สำคัญ: เพื่อข้ามปัญหา CORS ของ Google Redirect
          body: JSON.stringify(payload)
        });
        
        // หมายเหตุ: mode 'no-cors' จะไม่สามารถอ่าน response body ได้ 
        // แต่ข้อมูลจะถูกส่งไปบันทึกที่ Sheets แน่นอน
        alert("ส่งข้อมูลการบันทึกแล้ว (กรุณาตรวจสอบที่ Google Sheets)");
        location.reload();
      } catch (err) {
        alert("เกิดข้อผิดพลาดในการเชื่อมต่อ");
        btn.disabled = false;
        btn.innerText = "บันทึกข้อมูล";
      }
    }
  
    // ผูกฟังก์ชันเข้ากับปุ่มบันทึก
    document.getElementById('saveBtn').onclick = saveData;
    
    // เรียกโหลดข้อมูลเมื่อเปิดหน้า
    window.onload = loadData;

    function populateArea() {
      const areaSelect = document.getElementById('area');
      const areas = [...new Set(rawData.map(item => item.area_thai))];
      areas.forEach(a => areaSelect.add(new Option(a, a)));
    }

    function filterDropdown(level) {
      const areaVal = document.getElementById('area').value;
      const provVal = document.getElementById('prov').value;
      const distVal = document.getElementById('dist').value;
      
      const provSelect = document.getElementById('prov');
      const distSelect = document.getElementById('dist');
      const subdSelect = document.getElementById('subd');

      if(level === 'prov') {
        provSelect.innerHTML = '<option value="">— เลือกจังหวัด —</option>';
        provSelect.disabled = false;
        const filtered = rawData.filter(i => i.area_thai === areaVal);
        [...new Set(filtered.map(i => i.prov_thai))].forEach(p => provSelect.add(new Option(p, p)));
      } else if(level === 'dist') {
        distSelect.innerHTML = '<option value="">— เลือกอำเภอ —</option>';
        distSelect.disabled = false;
        const filtered = rawData.filter(i => i.prov_thai === provVal);
        [...new Set(filtered.map(i => i.dist_thai))].forEach(d => distSelect.add(new Option(d, d)));
      } else if(level === 'subd') {
        subdSelect.innerHTML = '<option value="">— เลือกตำบล —</option>';
        subdSelect.disabled = false;
        const filtered = rawData.filter(i => i.dist_thai === distVal);
        [...new Set(filtered.map(i => i.subd_thai))].forEach(s => subdSelect.add(new Option(s, s)));
      }
      updatePreview();
    }

    
    // ฟังก์ชันสำหรับดึง "รหัส" จากข้อมูลที่เลือก
    function getSelectedCodes() {
      const areaVal = document.getElementById('area').value;
      const provVal = document.getElementById('prov').value;
      const distVal = document.getElementById('dist').value;
      const subdVal = document.getElementById('subd').value;
    
      // ค้นหาแถวใน rawData ที่ตรงกับเงื่อนไขทั้งหมดที่เลือก
      const match = rawData.find(i => 
        i.area_thai === areaVal && 
        i.prov_thai === provVal && 
        i.dist_thai === distVal && 
        i.subd_thai === subdVal
      );
    
      return match ? match : null;
    }
    
    
    function updatePreview() {
      const name = document.getElementById('branName').value || "—";
      const house = document.getElementById('addrHouse').value;
      const road = document.getElementById('addrRoad').value;
      const zip = document.getElementById('zipCode').value;
      
      const area = document.getElementById('area').value;
      const prov = document.getElementById('prov').value;
      const dist = document.getElementById('dist').value;
      const subd = document.getElementById('subd').value;
    
      // 1. แสดงชื่อสำนักงาน
      document.getElementById('viewName').innerText = name;
      
      // 2. จัดการที่อยู่แบบตัวเต็ม (ตาม Pattern ที่ต้องการ)
      let fullAddr = [];
      if (house) fullAddr.push(house);
      if (road) fullAddr.push("ถนน" + road.replace("ถนน", "").replace("ถ.", ""));
      if (subd) fullAddr.push("ตำบล" + subd);
      if (dist) {
        // ถ้าเป็นกรุงเทพ ใช้คำว่า "เขต" ถ้าจังหวัดอื่นใช้ "อำเภอ"
        const distPrefix = (prov === "กรุงเทพมหานคร") ? "เขต" : "อำเภอ";
        fullAddr.push(distPrefix + dist);
      }
      if (prov) {
        const provPrefix = (prov === "กรุงเทพมหานคร") ? "" : "จังหวัด";
        fullAddr.push(provPrefix + prov);
      }
      if (zip) fullAddr.push(zip);
    
      document.getElementById('viewAddress').innerText = fullAddr.join(", ") || "—";
    
      // 3. จัดการรหัส bran_iden (ดึงรหัสที่จับคู่กันมาต่อกัน)
      const codes = getSelectedCodes();
      if (codes) {
        // นำรหัสมาต่อกันตามที่ตกลงไว้ (ตัวอย่าง: area+prov+dist+subd)
        const combinedCode = `${codes.area_code}${codes.prov_code}${codes.dist_code}${codes.subd_code}`;
        document.getElementById('previewCode').innerText = combinedCode;
        document.getElementById('saveBtn').disabled = (name === "—");
      } else {
        document.getElementById('previewCode').innerText = "—";
        document.getElementById('saveBtn').disabled = true;
      }
    }

  </script>
</body>
</html>







