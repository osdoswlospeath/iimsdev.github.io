<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IIMS | สร้างรหัสสำนักงาน</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="header-placeholder"></div>
<script src="script.js"></script>

<!-- Loading Overlay -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">กำลังโหลดข้อมูลพื้นที่...</div>
</div>

<div class="container">
  <div class="card">
    <h2>สร้างรหัสสำนักงาน</h2>
    <p class="notice">ระบุชื่อและที่ตั้งสำนักงาน ระบบจะสร้างข้อมูลรหัสให้อัตโนมัติ</p>

    <!-- FORM เดียว ครอบทุก input (ไม่ซ้ำ ID) -->
    <form id="officeForm"
          action="https://script.google.com/macros/s/AKfycbwYo97WW15ZYbbMe7d0-1Ba2N3suVibyxc0Z64HJBBaXGBniXdzBGCgbqazNnXdnhML/exec"
          method="POST"
          target="hidden_iframe">

      <input type="hidden" name="action" value="saveOffice">
      <input type="hidden" name="bran_iden" id="hidden_bran_iden">
      <input type="hidden" name="bran_addr" id="hidden_bran_addr">
      <input type="hidden" name="area_code" id="hidden_area_code">
      <input type="hidden" name="prov_code" id="hidden_prov_code">
      <input type="hidden" name="dist_code" id="hidden_dist_code">
      <input type="hidden" name="subd_code" id="hidden_subd_code">
      <input type="hidden" name="subd_thai" id="hidden_subd_thai">
      <input type="hidden" name="dist_thai" id="hidden_dist_thai">
      <input type="hidden" name="prov_thai" id="hidden_prov_thai">

      <!-- 1. ชื่อสำนักงาน -->
      <div class="form-row">
        <label>ชื่อสำนักงาน</label>
        <input type="text" id="branName" name="bran_name" required oninput="updatePreview()">
      </div>

      <!-- 2-4 ที่อยู่ -->
      <div class="grid">
        <div class="form-row">
          <label>เลขที่ / อาคาร / หมู่</label>
          <input type="text" id="addrHouse" name="addr_house" oninput="updatePreview()">
        </div>
        <div class="form-row">
          <label>ซอย / ถนน</label>
          <input type="text" id="addrRoad" name="addr_road" oninput="updatePreview()">
        </div>
        <div class="form-row">
          <label>รหัสไปรษณีย์</label>
          <input type="text" id="zipCode" name="zip_code" maxlength="5" oninput="updatePreview()">
        </div>
      </div>

      <!-- 5-8 พื้นที่ -->
      <div class="grid">
        <div class="form-row">
          <label>พื้นที่</label>
          <select id="area" onchange="filterDropdown('prov')">
            <option value="">— เลือกพื้นที่ —</option>
          </select>
        </div>
      
        <div class="form-row">
          <label>จังหวัด</label>
          <select id="prov" onchange="filterDropdown('dist')" disabled>
            <option value="">— เลือกจังหวัด —</option>
          </select>
        </div>
      
        <div class="form-row">
          <label>อำเภอ</label>
          <select id="dist" onchange="filterDropdown('subd')" disabled>
            <option value="">— เลือกอำเภอ —</option>
          </select>
        </div>
      
        <div class="form-row">
          <label>ตำบล</label>
          <select id="subd" onchange="updatePreview()" disabled>
            <option value="">— เลือกตำบล —</option>
          </select>
        </div>
      </div>

      <!-- 9-11 -->
      <div class="grid">
        <div class="form-row">
          <label>ขนาดสำนักงาน</label>
          <select id="branSize" name="bran_size" required onchange="updateHierDropdown(); updatePreview();">
            <option value="">— เลือก —</option>
            <option value="XL">XL</option>
            <option value="L">L</option>
            <option value="M">M</option>
            <option value="S">S</option>
            <option value="XS">XS</option>
          </select>
        </div>
        <div class="form-row">
          <label>สำนักงานต้นสังกัด</label>
          <select id="branHier" name="bran_hier" disabled></select>
        </div>
        <div class="form-row">
          <label>คลังพัสดุ</label>
          <select id="branWare" name="bran_ware">
            <option value="FALSE">ไม่มี</option>
            <option value="TRUE">มี</option>
          </select>
        </div>
      </div>

      <!-- 12-13 -->
      <div class="grid">
        <div class="form-row">
          <label>ผู้ลงข้อมูล</label>
          <input type="text" id="creaUser" name="crea_user" required>
        </div>
        <div class="form-row">
          <label>เบอร์ติดต่อ</label>
          <input type="tel" id="creaTele" name="crea_tele" required>
        </div>
      </div>

      <!-- Preview -->
      <div class="preview">
        <div><strong>ชื่อ:</strong> <span id="viewName">—</span></div>
        <div><strong>รหัส:</strong> <span id="previewCode">—</span></div>
        <div><strong>ที่อยู่:</strong> <span id="viewAddress">—</span></div>
      </div>

      <div class="actions">
        <button type="button" onclick="location.reload()">ล้างข้อมูล</button>
        <button type="submit">บันทึกข้อมูล</button>
      </div>

    </form>
    <iframe name="hidden_iframe" style="display:none"></iframe>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzcYswgN84ikLt1LRAQMSc6VDQ0tSEYb-jtgxyDGRXdjkSAC8E6VXV1gKz4ZWhPKTL0/exec';

async function loadAreaMaster() {
  const overlay = document.getElementById('loadingOverlay');
  try {
    const r = await fetch(API_URL + '?action=getAreaMaster');
    const data = await r.json();
    if (typeof initAreaDropdowns === 'function') initAreaDropdowns(data);
  } catch (e) {
    console.error(e);
  } finally {
    overlay.style.display = 'none';
  }
}

// ก่อน submit รวมค่าที่ต้องคำนวณ
const form = document.getElementById('officeForm');
form.addEventListener('submit', () => {
  document.getElementById('hidden_bran_iden').value = document.getElementById('previewCode').innerText;
  document.getElementById('hidden_bran_addr').value = document.getElementById('viewAddress').innerText;

  document.getElementById('hidden_area_code').value = area.value;
  document.getElementById('hidden_prov_code').value = prov.value;
  document.getElementById('hidden_dist_code').value = dist.value;
  document.getElementById('hidden_subd_code').value = subd.value;

  document.getElementById('hidden_subd_thai').value = subd.options[subd.selectedIndex].text;
  document.getElementById('hidden_dist_thai').value = dist.options[dist.selectedIndex].text;
  document.getElementById('hidden_prov_thai').value = prov.options[prov.selectedIndex].text;
});

document.addEventListener('DOMContentLoaded', loadAreaMaster);

  function updatePreview() {
  const name = document.getElementById('branName')?.value || '';

  const house = document.getElementById('addrHouse')?.value || '';
  const road  = document.getElementById('addrRoad')?.value || '';
  const zip   = document.getElementById('zipCode')?.value || '';

  const areaSel = document.getElementById('area');
  const provSel = document.getElementById('prov');
  const distSel = document.getElementById('dist');
  const subdSel = document.getElementById('subd');

  const areaCode = areaSel?.value || '';
  const provCode = provSel?.value || '';
  const distCode = distSel?.value || '';
  const subdCode = subdSel?.value || '';

  const subdText = subdSel?.selectedOptions[0]?.text || '';
  const distText = distSel?.selectedOptions[0]?.text || '';
  const provText = provSel?.selectedOptions[0]?.text || '';

  /* ===== bran_iden ===== */
  const branIden = [areaCode, provCode, distCode, subdCode]
    .filter(v => v !== '')
    .join('');

  /* ===== bran_addr ===== */
  const addressParts = [
    house,
    road,
    subdText ? 'ต.' + subdText : '',
    distText ? 'อ.' + distText : '',
    provText ? 'จ.' + provText : '',
    zip ? 'รหัสไปรษณีย์ ' + zip : ''
  ].filter(v => v.trim() !== '');

  const address = addressParts.join(' ');

  /* ===== Update Preview ===== */
  document.getElementById('viewName').innerText = name || '—';
  document.getElementById('previewCode').innerText = branIden || '—';
  document.getElementById('viewAddress').innerText = address || '—';
}

let AREA_DATA = [];

function initAreaDropdowns(data) {
  console.log('AREA MASTER LOADED:', data.length);

  AREA_DATA = data;

  const areaSel = document.getElementById('area');
  areaSel.innerHTML = '<option value="">— เลือกพื้นที่ —</option>';

  const seen = {};

  data.forEach(r => {
    if (!seen[r.area_code]) {
      seen[r.area_code] = true;
      const opt = document.createElement('option');
      opt.value = r.area_code;
      opt.text = r.area_thai || r.area_code;
      areaSel.appendChild(opt);
    }
  });
}

function filterDropdown(level) {
  const area = document.getElementById('area');
  const prov = document.getElementById('prov');
  const dist = document.getElementById('dist');
  const subd = document.getElementById('subd');

  /* ===== จังหวัด ===== */
  if (level === 'prov') {
    prov.innerHTML = '<option value="">— เลือกจังหวัด —</option>';
    dist.innerHTML = '<option value="">— เลือกอำเภอ —</option>';
    subd.innerHTML = '<option value="">— เลือกตำบล —</option>';

    prov.disabled = false;
    dist.disabled = true;
    subd.disabled = true;

    const seen = {};
    AREA_DATA.forEach(r => {
      if (
        r.area_code === area.value &&
        r.prov_code && r.prov_thai &&     // ❗ กันช่องว่าง
        !seen[r.prov_code]
      ) {
        seen[r.prov_code] = true;
        prov.add(new Option(r.prov_thai, r.prov_code));
      }
    });
  }

  /* ===== อำเภอ ===== */
  if (level === 'dist') {
    dist.innerHTML = '<option value="">— เลือกอำเภอ —</option>';
    subd.innerHTML = '<option value="">— เลือกตำบล —</option>';

    dist.disabled = false;
    subd.disabled = true;

    const seen = {};
    AREA_DATA.forEach(r => {
      if (
        r.prov_code === prov.value &&
        r.dist_code && r.dist_thai &&     // ❗ กันช่องว่าง
        !seen[r.dist_code]
      ) {
        seen[r.dist_code] = true;
        dist.add(new Option(r.dist_thai, r.dist_code));
      }
    });
  }

  /* ===== ตำบล (แกนหลักของปัญหา) ===== */
  if (level === 'subd') {
    subd.innerHTML = '<option value="">— เลือกตำบล —</option>';
    subd.disabled = false;

    AREA_DATA.forEach(r => {
      if (
        r.dist_code === dist.value &&     // ✅ row เดียวกันเท่านั้น
        r.subd_code && r.subd_thai        // ❗ กันช่องว่าง
      ) {
        subd.add(new Option(r.subd_thai, r.subd_code));
      }
    });
  }

  updatePreview();
}
  
async function updateHierDropdown() {
  const size = document.getElementById('branSize').value;
  const hierSel = document.getElementById('branHier');

  hierSel.innerHTML = '';
  hierSel.disabled = true;

  // XL → ไม่มีสังกัด
  if (size === 'XL' || !size) {
    hierSel.innerHTML = '<option value=\"\">— ไม่มีสังกัด —</option>';
    return;
  }

  const area = document.getElementById('area').value;
  const prov = document.getElementById('prov').value;

  if (!area || !prov) {
    hierSel.innerHTML = '<option value=\"\">— เลือกพื้นที่/จังหวัดก่อน —</option>';
    return;
  }

  try {
    const r = await fetch(
      API_URL + '?action=getOffices'
      + '&area_code=' + area
      + '&prov_code=' + prov
    );
    const list = await r.json();

    hierSel.innerHTML = '<option value=\"\">— เลือกสำนักงานต้นสังกัด —</option>';

    list.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.iden;
      opt.text = o.name;
      hierSel.appendChild(opt);
    });

    hierSel.disabled = false;
  } catch (e) {
    console.error('load hier error', e);
    hierSel.innerHTML = '<option value=\"\">— โหลดข้อมูลไม่สำเร็จ —</option>';
  }
}
  
</script>
</body>
</html>





