<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IIMS | สร้างรหัสสำนักงาน</title>
  <link rel="stylesheet" href="style.css">
</head>
  
<div id="header-placeholder"></div>

<script src="script.js"></script>
  
<body>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">กำลังโหลดข้อมูลพื้นที่...</div>
  </div>
  

  
  <div class="container">
    <div class="card">
      <h2>สร้างรหัสสำนักงาน</h2>
      <p class="notice">ระบุชื่อและที่ตั้งสำนักงาน ระบบจะสร้างข้อมูลรหัสให้อัตโนมัติ</p>

      <div class="form-row">
        <label>ชื่อสำนักงาน</label>
        <input type="text" id="branName" placeholder="เช่น การไฟฟ้าส่วนภูมิภาค สาขาเมืองเชียงใหม่" oninput="updatePreview()" />
      </div>

      <div class="grid">
        <div class="form-row">
          <label>เลขที่ / อาคาร / หมู่</label>
          <input type="text" id="addrHouse" placeholder="เช่น เลขที่ 123/4 หมู่ 5" oninput="updatePreview()" />
        </div>
        <div class="form-row">
          <label>ซอย / ถนน</label>
          <input type="text" id="addrRoad" placeholder="เช่น ถนนพหลโยธิน หรือ - " oninput="updatePreview()" />
        </div>
        <div class="form-row">
          <label>รหัสไปรษณีย์</label>
          <input type="text" id="zipCode" placeholder="เช่น 10110" maxlength="5" oninput="updatePreview()" />
        </div>
      </div>

      <div class="grid">
        <div class="form-row">
          <label>พื้นที่</label>
          <select id="area" onchange="filterDropdown('prov')"><option value="">— เลือกพื้นที่ —</option></select>
        </div>
        <div class="form-row">
          <label>จังหวัด</label>
          <select id="prov" disabled onchange="filterDropdown('dist')"><option value="">— เลือกจังหวัด —</option></select>
        </div>
        <div class="form-row">
          <label>อำเภอ/เขต</label>
          <select id="dist" disabled onchange="filterDropdown('subd')"><option value="">— เลือกอำเภอ —</option></select>
        </div>
        <div class="form-row">
          <label>ตำบล/แขวง</label>
          <select id="subd" disabled onchange="updatePreview()"><option value="">— เลือกตำบล —</option></select>
        </div>
      </div>

      <div class="grid">
        <div class="form-row">
          <label>ขนาดสำนักงาน</label>
          <select id="branSize" onchange="updateHierDropdown(); updatePreview();">
            <option value="">— เลือกขนาด —</option>
            <option value="XL">XL</option>
            <option value="L">L</option>
            <option value="M">M</option>
            <option value="S">S</option>
            <option value="XS">XS</option>
          </select>
        </div>
      
        <div class="form-row">
          <label>สำนักงานต้นสังกัด</label>
          <select id="branHier" disabled onchange="updatePreview()">
            <option value="">— กรุณาเลือกขนาดและพื้นที่ก่อน —</option>
          </select>
        </div>
      
        <div class="form-row">
          <label>มีคลังพัสดุ</label>
          <select id="branWare" onchange="updatePreview()">
            <option value="FALSE">ไม่มี</option>
            <option value="TRUE">มี</option>
          </select>
        </div>
      </div>
      
      <div class="preview" style="text-align: left; padding: 20px;">
        <div style="margin-bottom: 15px;">
          <strong style="color:var(--purple);">1. ชื่อสำนักงาน:</strong>
          <div id="viewName" style="font-size: 1.1rem; margin-top: 5px;">—</div>
        </div>
        <div style="margin-bottom: 15px;">
          <strong style="color:var(--purple);">2. รหัสสำนักงาน:</strong><br>
          <div id="previewCode" class="badge">—</div>
        </div>
        <div>
          <strong style="color:var(--purple);">3. ที่อยู่:</strong>
          <div id="viewAddress" style="font-size: 0.95rem; margin-top: 5px; line-height: 1.6;">—</div>
        </div>
      </div>

      <div class="grid">
        <div class="form-row">
          <label>ชื่อ-นามสกุล ผู้ลงข้อมูล</label>
          <input type="text" id="creaUser" placeholder="ระบุชื่อผู้บันทึก" />
        </div>
        <div class="form-row">
          <label>เบอร์โทรศัพท์</label>
          <input type="tel" id="creaTele" placeholder="เช่น 081-234-5678 หรือ (12)34567" />
        </div>
      </div>

      <div class="footer">
        © <span id="year"></span> IIMS — แผนกงานประกันภัย กองสนับสนุนงานองค์กร
      </div>     
      
      <form action="https://script.google.com/macros/s/AKfycbwYo97WW15ZYbbMe7d0-1Ba2N3suVibyxc0Z64HJBBaXGBniXdzBGCgbqazNnXdnhML/exec" method="POST">
        
        <input type="hidden" name="action" value="saveOffice"> <input type="hidden" id="hidden_bran_iden" name="bran_iden"> <input type="hidden" id="hidden_bran_addr" name="bran_addr"> <input type="text" id="branName" name="bran_name" oninput="updatePreview()" />
        <select id="branSize" name="bran_size" onchange="...">...</select>
        <select id="branHier" name="bran_hier">...</select>
        <select id="branWare" name="bran_ware">...</select>
      
        <div class="actions">
          <button type="button" onclick="location.reload()" class="btn">ล้างข้อมูล</button>
          <button type="submit" id="saveBtn" class="btn primary">บันทึกข้อมูล</button>
        </div>
      </form>

    </div>
  </div>

  
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwYo97WW15ZYbbMe7d0-1Ba2N3suVibyxc0Z64HJBBaXGBniXdzBGCgbqazNnXdnhML/exec";
    
    // ฟังก์ชันดึงสำนักงานแม่มาใส่ Dropdown
 sync function loadAreaData() { // เปลี่ยนชื่อให้ตรงความหมาย
  const overlay = document.getElementById('loadingOverlay');
  try {
    const resp = await fetch(`${API_URL}?action=getAreaData`, { // เรียก action ใหม่
      method: 'GET',
      redirect: 'follow'
    });
    const data = await resp.json();
    
    // ตรงนี้ต้องส่ง data ไปให้ฟังก์ชันใน script.js (ที่คุณมีอยู่แล้ว) 
    // เพื่อกระจายข้อมูลลง Dropdown พื้นที่/จังหวัด/อำเภอ [cite: 4, 5, 6]
    if (typeof initAreaDropdowns === "function") {
      initAreaDropdowns(data); 
    }

  } catch (e) {
    console.error("Fetch Error:", e);
  } finally {
    if (overlay) overlay.style.display = 'none'; // ปิด Loading เสมอ 
  }
}
        
    // ฟังก์ชันบันทึกข้อมูล
    async function saveData() {
      const user = document.getElementById('creaUser').value;
      const size = document.getElementById('branSize').value;
      
      if (!user || !size || size === "-") {
        alert("กรุณากรอกข้อมูลให้ครบถ้วน");
        return;
      }
    
    const payload = {
        action: 'saveOffice',
        data: {
          bran_iden: document.getElementById('previewCode').innerText,
          bran_name: document.getElementById('branName').value,
          bran_addr: document.getElementById('viewAddress').innerText,
          bran_size: document.getElementById('branSize').value,
          bran_hier: document.getElementById('branHier').value,
          bran_ware: document.getElementById('branWare').value
        }
      };
    
      try {
          // การ POST ไปยัง GAS ต้องใช้ Content-Type: text/plain เพื่อเลี่ยง CORS preflight
          await fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors', // สำหรับการบันทึก (POST) ใช้ no-cors ได้ถ้าไม่ต้องการรับ response กลับมาเช็ค
            body: JSON.stringify(payload)
          });
          
          alert("บันทึกข้อมูลเรียบร้อยแล้ว");
          location.reload();
        } catch (err) {
          alert("เกิดข้อผิดพลาด");
        }
      }

    // เพิ่มสคริปต์เล็กน้อยเพื่อดึงค่าจาก div Preview มาใส่ใน hidden input ก่อนส่ง
    document.querySelector('form').onsubmit = function() {
      document.getElementById('hidden_bran_iden').value = document.getElementById('previewCode').innerText;
      document.getElementById('hidden_bran_addr').value = document.getElementById('viewAddress').innerText;
    };

      // รับข้อมูลที่ส่งมาจาก GAS (บรรทัดนี้คือหัวใจ)
    const masterData = <?!= masterData ?>;
  
    document.addEventListener('DOMContentLoaded', function() {
      const overlay = document.getElementById('loadingOverlay');
      
      try {
        // นำ masterData ที่ได้มาไปใส่ใน Dropdown พื้นที่/จังหวัด (ใช้ Logic เดิมของคุณ)
        if (masterData) {
          initAreaDropdowns(masterData); 
        }
      } catch (e) {
        console.error("Error processing data:", e);
      } finally {
        // ปิดหน้ากาก Loading ทันที เพราะข้อมูลมาพร้อมกับหน้าเว็บแล้ว
        if (overlay) overlay.style.display = 'none';
      }
    });
    
    // โหลดข้อมูลเมื่อเปิดหน้าเว็บ
    document.addEventListener('DOMContentLoaded', loadParentOffices);

    
  </script>
</body>
</html>


