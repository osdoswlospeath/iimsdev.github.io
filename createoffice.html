<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IIMS | สร้างรหัสสำนักงาน</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="header-placeholder"></div>
<script src="script.js"></script>

<!-- Loading Overlay -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">กำลังโหลดข้อมูลพื้นที่...</div>
</div>

<div class="container">
  <div class="card">
    <h2>สร้างรหัสสำนักงาน</h2>
    <p class="notice">ระบุชื่อและที่ตั้งสำนักงาน ระบบจะสร้างข้อมูลรหัสให้อัตโนมัติ</p>

    <!-- FORM เดียว ครอบทุก input (ไม่ซ้ำ ID) -->
    <form id="officeForm"
          action="https://script.google.com/macros/s/AKfycbwYo97WW15ZYbbMe7d0-1Ba2N3suVibyxc0Z64HJBBaXGBniXdzBGCgbqazNnXdnhML/exec"
          method="POST"
          target="hidden_iframe">

      <input type="hidden" name="action" value="saveOffice">
      <input type="hidden" name="bran_iden" id="hidden_bran_iden">
      <input type="hidden" name="bran_addr" id="hidden_bran_addr">
      <input type="hidden" name="area_code" id="hidden_area_code">
      <input type="hidden" name="prov_code" id="hidden_prov_code">
      <input type="hidden" name="dist_code" id="hidden_dist_code">
      <input type="hidden" name="subd_code" id="hidden_subd_code">
      <input type="hidden" name="subd_thai" id="hidden_subd_thai">
      <input type="hidden" name="dist_thai" id="hidden_dist_thai">
      <input type="hidden" name="prov_thai" id="hidden_prov_thai">

      <!-- 1. ชื่อสำนักงาน -->
      <div class="form-row">
        <label>ชื่อสำนักงาน</label>
        <input type="text" id="branName" name="bran_name" required oninput="updatePreview()">
      </div>

      <!-- 2-4 ที่อยู่ -->
      <div class="grid">
        <div class="form-row">
          <label>เลขที่ / อาคาร / หมู่</label>
          <input type="text" id="addrHouse" name="addr_house" oninput="updatePreview()">
        </div>
        <div class="form-row">
          <label>ซอย / ถนน</label>
          <input type="text" id="addrRoad" name="addr_road" oninput="updatePreview()">
        </div>
        <div class="form-row">
          <label>รหัสไปรษณีย์</label>
          <input type="text" id="zipCode" name="zip_code" maxlength="5" oninput="updatePreview()">
        </div>
      </div>

      <!-- 5-8 พื้นที่ -->
      <div class="grid">
        <div class="form-row">
          <label>พื้นที่</label>
          <select id="area" onchange="filterDropdown('prov')" required></select>
        </div>
        <div class="form-row">
          <label>จังหวัด</label>
          <select id="prov" onchange="filterDropdown('dist')" disabled required></select>
        </div>
        <div class="form-row">
          <label>อำเภอ</label>
          <select id="dist" onchange="filterDropdown('subd')" disabled required></select>
        </div>
        <div class="form-row">
          <label>ตำบล</label>
          <select id="subd" disabled required onchange="updatePreview()"></select>
        </div>
      </div>

      <!-- 9-11 -->
      <div class="grid">
        <div class="form-row">
          <label>ขนาดสำนักงาน</label>
          <select id="branSize" name="bran_size" required onchange="updateHierDropdown(); updatePreview();">
            <option value="">— เลือก —</option>
            <option value="XL">XL</option>
            <option value="L">L</option>
            <option value="M">M</option>
            <option value="S">S</option>
            <option value="XS">XS</option>
          </select>
        </div>
        <div class="form-row">
          <label>สำนักงานต้นสังกัด</label>
          <select id="branHier" name="bran_hier" disabled></select>
        </div>
        <div class="form-row">
          <label>คลังพัสดุ</label>
          <select id="branWare" name="bran_ware">
            <option value="FALSE">ไม่มี</option>
            <option value="TRUE">มี</option>
          </select>
        </div>
      </div>

      <!-- 12-13 -->
      <div class="grid">
        <div class="form-row">
          <label>ผู้ลงข้อมูล</label>
          <input type="text" id="creaUser" name="crea_user" required>
        </div>
        <div class="form-row">
          <label>เบอร์ติดต่อ</label>
          <input type="tel" id="creaTele" name="crea_tele" required>
        </div>
      </div>

      <!-- Preview -->
      <div class="preview">
        <div><strong>ชื่อ:</strong> <span id="viewName">—</span></div>
        <div><strong>รหัส:</strong> <span id="previewCode">—</span></div>
        <div><strong>ที่อยู่:</strong> <span id="viewAddress">—</span></div>
      </div>

      <div class="actions">
        <button type="button" onclick="location.reload()">ล้างข้อมูล</button>
        <button type="submit">บันทึกข้อมูล</button>
      </div>

    </form>
    <iframe name="hidden_iframe" style="display:none"></iframe>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwYo97WW15ZYbbMe7d0-1Ba2N3suVibyxc0Z64HJBBaXGBniXdzBGCgbqazNnXdnhML/exec';

async function loadAreaMaster() {
  const overlay = document.getElementById('loadingOverlay');
  try {
    const r = await fetch(API_URL + '?action=getAreaMaster');
    const data = await r.json();
    if (typeof initAreaDropdowns === 'function') initAreaDropdowns(data);
  } catch (e) {
    console.error(e);
  } finally {
    overlay.style.display = 'none';
  }
}

// ก่อน submit รวมค่าที่ต้องคำนวณ
const form = document.getElementById('officeForm');
form.addEventListener('submit', () => {
  document.getElementById('hidden_bran_iden').value = document.getElementById('previewCode').innerText;
  document.getElementById('hidden_bran_addr').value = document.getElementById('viewAddress').innerText;

  document.getElementById('hidden_area_code').value = area.value;
  document.getElementById('hidden_prov_code').value = prov.value;
  document.getElementById('hidden_dist_code').value = dist.value;
  document.getElementById('hidden_subd_code').value = subd.value;

  document.getElementById('hidden_subd_thai').value = subd.options[subd.selectedIndex].text;
  document.getElementById('hidden_dist_thai').value = dist.options[dist.selectedIndex].text;
  document.getElementById('hidden_prov_thai').value = prov.options[prov.selectedIndex].text;
});

document.addEventListener('DOMContentLoaded', loadAreaMaster);
</script>
</body>
</html>
